
  <h3 id="CommentsHeader">All Comments</h3>
  <div id="c_widget">All comments except those of Moheb Rofail<div id="c_container"></div></div>
  <script>
  document.title += ` - All Comments`;
  const s_stylePath = 'includes/comment-widget/comment-widget.css';
  const s_sheetId = '1Dw5nnAQFv26gR5_C0UUc-je-PLjZ0Zs4p6SuSgRDBbE';
  const s_commentsPerPage = 50; // The max amount of comments that can be displayed on one page, any number >= 1 (Replies not counted)
  // Initialize misc things
  const c_container = document.getElementById('c_container');
  let v_pageNum = 1;
  let comments = [];
  // Word filter - Censor profanity, etc
  const s_wordFilterOn = false; // True for on, false for off
  const s_filterReplacement = '****'; // Change what filtered words are censored with (**** is the default)
  const s_filteredWords = [ // Add words to filter by putting them in quotes and separating with commas (ie. 'heck', 'dang')
      'heck', 'dang', 'fuck', 'dick', 'pussy'
  ]
  const s_noCommentsText = 'No comments yet!';
  const s_leftButtonText = '<<';
const s_rightButtonText = '>>';
  // Fetches the Google Sheet resource from the provided URL
  function getSheet(url) {
      return new Promise(function (resolve, reject) {
          fetch(url).then(response => {
              if (!response.ok) {reject('Could not find Google Sheet with that URL')} // Checking for a 404
              else {
                  response.text().then(data => {
                      if (!data) {reject('Invalid data pulled from sheet')}
                      resolve(data);
                  })
              }
          })
      })
  }
  // Get the data
  const url = `https://docs.google.com/spreadsheets/d/${s_sheetId}/gviz/tq?`;
  const retrievedSheet = getSheet(url);
  // Processes comment data with the Google Sheet ID
  function getComments() {
    // Do stuff with the data here
    retrievedSheet.then(result => {
        // The data comes with extra stuff at the beginning, get rid of it
        const json = JSON.parse(result.split('\n')[1].replace(/google.visualization.Query.setResponse\(|\);/g, ''));

        // Need index of page column for checking if comments are for the right page
        const isPage = (col) => col.label == 'Page';
        let pageIdx = json.table.cols.findIndex(isPage);
        
        // Turn that data into usable comment data
        // All of the messy val checks are because Google Sheets can be weird sometimes with comment deletion
        comments = [];
        if (json.table.parsedNumHeaders > 0) { // Check if any comments exist in the sheet at all before continuing
            for (r = 0; r < json.table.rows.length; r++) {
                // Check for null rows
                let val1;
                if (!json.table.rows[r].c[pageIdx]) {val1 = ''}
                else {val1 = json.table.rows[r].c[pageIdx].v}

                // Check if the page name matches before adding to comment array
                //if (val1 == v_pagePath) { 
                    let comment = {}
                    for (c = 0; c < json.table.cols.length; c++) {
                        // Check for null values
                        let val2;
                        if (!json.table.rows[r].c[c]) {val2 = ''}
                        else {val2 = json.table.rows[r].c[c].v}

                        // Finally set the value properly
                        comment[json.table.cols[c].label] = val2;
                    }
                    comment.Timestamp2 = json.table.rows[r].c[0].f;
                    comments.push(comment);
                //}
            }
        }

        // Check for empty comments before displaying to page
        if (comments.length == 0 || Object.keys(comments[0]).length < 2) { // Once again, Google Sheets can be weird
            c_container.innerHTML = s_noCommentsText;
        } else {displayComments(comments)}
    })
}
function displayComments(comments) {
    // Clear for re-display
    a_commentDivs = [];
    c_container.innerHTML = '';
    // Values for pagination
    v_amountOfPages = Math.ceil(comments.length / s_commentsPerPage);
    v_commentMax = s_commentsPerPage * v_pageNum;
    v_commentMin = v_commentMax - s_commentsPerPage;
    document.getElementById("CommentsHeader").innerHTML += ` : ${comments.length}`;
    // Main comments (not replies)
    comments.reverse(); // Newest comments go to top
    for (i = 0; i < comments.length; i++) {
      
      // Not to show comments made by me.
        if (comments[i].Name == "Moheb Rofail") continue;
        let comment = createComment(comments[i]);
        
        if(comment.Name == "Moheb Rofail") continue;
        // Choose whether to display or not based on page number
        comment.style.display = 'none';
        if (i >= v_commentMin && i < v_commentMax) {comment.style.display = 'block'}

        comment.className = 'c-comment';
        c_container.appendChild(comment);
        a_commentDivs.push(document.getElementById(comment.id)); // Add to array for use later
    }

    // Handle pagination if there's more than one page
    if (v_amountOfPages > 1) {
        let pagination = document.createElement('div');

        leftButton = document.createElement('button');
        leftButton.innerHTML = s_leftButtonText; leftButton.id = 'c_leftButton'; leftButton.name = 'left';
        leftButton.setAttribute('onclick', `changePage(this.name)`);
        if (v_pageNum == 1) {leftButton.disabled = true} // Can't go before page 1
        leftButton.className = 'c-paginationButton';
        pagination.appendChild(leftButton);

        rightButton = document.createElement('button');
        rightButton.innerHTML = s_rightButtonText; rightButton.id = 'c_rightButton'; rightButton.name = 'right';
        rightButton.setAttribute('onclick', `changePage(this.name)`);
        if (v_pageNum == v_amountOfPages) {rightButton.disabled = true} // Can't go after the last page
        rightButton.className = 'c-paginationButton';
        pagination.appendChild(rightButton);

        pagination.id = 'c_pagination';
        c_container.appendChild(pagination);
    }
}
// Create basic HTML comment, reply or not
function createComment(data) {
    let comment = document.createElement('div');

    // Set the ID (uses Name + Full Timestamp format)
    const id = data.Name + '|--|' + data.Timestamp2;
    comment.id = id;

    // Name of user
    let filteredName = data.Name;
    if (s_wordFilterOn) {filteredName = filteredName.replace(v_filteredWords, s_filterReplacement)}

    // Website URL, if one was provided
    if (data.Website) {
        let site = document.createElement('a');
        site.innerText = filteredName;
        site.href = data.Website;
        site.className = 'c-name';
        site.target = '_blank';
        site.rel = 'nofollow';
        if(data.Moderated == false) {
            site.innerText = '';
        }
        comment.appendChild(site);
    } else {
      let name = document.createElement('b');
      name.innerText = filteredName;
      name.className = 'c-name';
      if(data.Moderated == false) {
          name.innerText = 'Guest'; // Change 'Guest' to whatever you want
      }
      comment.appendChild(name); 
    }
    
    // at word
    let atWord = document.createElement('span');
    atWord.innerText = `at`;
    comment.appendChild(atWord);
     
    // pageURL
    let pageURL = document.createElement('a');
    pageURL.innerHTML = `<a href="${data.Page}"> ${getPageTitle(data.Page)}</a>`;
    pageURL.className = 'c-postURL';
    comment.appendChild(pageURL);
    //if (data.Name != "Moheb Rofail")
    return comment;
  }

  function changePage(dir) {
    const leftButton = document.getElementById('c_leftButton');
    const rightButton = document.getElementById('c_rightButton');

    // Find directional number
    let num;
    switch (dir) {
        case 'left': num = -1; break;
        case 'right': num = 1; break;
        default: num = 0; break;
    }
    let targetPage = v_pageNum + num;

    // Cancel if impossible direction for safety, should never happen though
    if (targetPage > v_amountOfPages || targetPage < 1) {return}

    // Enable/disable buttons if needed
    leftButton.disabled = false; rightButton.disabled = false;
    if (targetPage == 1) {leftButton.disabled = true} // Can't go before page 1
    if (targetPage == v_amountOfPages) {rightButton.disabled = true} // Can't go past the last page

    // Hide all comments and then display the correct ones
    v_pageNum = targetPage;
    v_commentMax = s_commentsPerPage * v_pageNum;
    v_commentMin = v_commentMax - s_commentsPerPage;
    for (i = 0; i < a_commentDivs.length; i++) {
        a_commentDivs[i].style.display = 'none';
        if (i >= v_commentMin && i < v_commentMax) {a_commentDivs[i].style.display = 'block'}
    }
}

  // get page title by relative url!
  function getPageTitle(text) {
    let pageTitle;
    // Check if text contains '/'
    if(text.includes('/')) {
      var splitText = text.split('/');
    
      // Check if second part contains 'post&p='
      if(splitText[1].includes('post&p=')) {
        var splitQuery = splitText[1].split('post&p=');
        
        // Replace '%20' with a space
        var decodedQuery = decodeURIComponent(splitQuery[1]);
        pageTitle = getPostTitle(decodedQuery);
      } else if (splitText[1] == "?page=guestBook") pageTitle = "Guest Book";
      else pageTitle = splitText[1];
    }
    return pageTitle.replace(/^\d+\s/, '');
  }
  getComments();
  </script>

